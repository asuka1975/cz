# 02 - 型システム

## 概要

Cz は静的型付け言語である。MS2 では複数のプリミティブ型、ユニット型、タプル型、構造体型、列挙型を提供する。

## 構文

```bnf
type        = prim_type | unit_type | tuple_type | named_type
prim_type   = "i8" | "i16" | "i32" | "i64" | "f32" | "f64" | "bool"
unit_type   = "(" ")"
tuple_type  = "(" type "," type ("," type)* ")"
named_type  = identifier
```

## プリミティブ型

### 整数型

| 型 | サイズ | 値の範囲 |
|---|---|---|
| `i8` | 1 byte | -128 〜 127 |
| `i16` | 2 byte | -32,768 〜 32,767 |
| `i32` | 4 byte | -2,147,483,648 〜 2,147,483,647 |
| `i64` | 8 byte | -9,223,372,036,854,775,808 〜 9,223,372,036,854,775,807 |

- 整数リテラル、算術演算、比較演算の結果として生成される
- サフィックスなしの整数リテラルは `i32` 型

### 浮動小数点型 (MS2)

| 型 | サイズ | 説明 |
|---|---|---|
| `f32` | 4 byte | IEEE 754 単精度浮動小数点数 |
| `f64` | 8 byte | IEEE 754 倍精度浮動小数点数 |

- 小数点を含むリテラル (`3.14`) で生成される
- サフィックスなしの浮動小数点リテラルは `f64` 型
- 浮動小数点型に対しては算術演算 (`+`, `-`, `*`, `/`) と比較演算が使用可能
- 浮動小数点型に対する `%` (剰余) 演算はサポートしない
- 浮動小数点型に対する論理演算 (`&&`, `||`, `!`) はサポートしない

### bool 型 (MS2)

- `true` と `false` の 2 値を取る独立した型
- `i32` とは異なる型であり、暗黙の変換は行わない
- 条件式 (`if` の条件、`while` の条件) では `bool` 型が要求される
- 比較演算子・論理演算子の結果は `bool` 型
- 論理演算子 (`&&`, `||`, `!`) のオペランドは `bool` 型でなければならない

### ユニット型 (MS2)

- `()` で表現される
- 値を持たないことを表す型
- `while` 式が `break` なしで終了した場合の値
- 戻り値なしの関数の戻り値型

## 型キャスト (MS2)

`as` キーワードを使った明示的な型変換を行う。

### 構文

```bnf
cast_expression = expression "as" type
```

### キャストルール

#### 整数型間のキャスト

- 拡大変換: 値が保持される (例: `i8` → `i32`)
- 縮小変換: ビットが切り捨てられる (例: `i32` → `i8` — 下位ビットのみ保持)

```cz
let a: i64 = 42i32 as i64;  // 拡大: 42
let b: i8 = 256i32 as i8;   // 縮小: 0 (下位8ビット)
```

#### 整数型 ↔ 浮動小数点型のキャスト

- 整数 → 浮動小数点: 最も近い値に変換 (精度が失われる場合がある)
- 浮動小数点 → 整数: 小数部を切り捨て (0方向への切り捨て)

```cz
let c: f64 = 42 as f64;     // 42.0
let d: i32 = 3.7 as i32;    // 3
let e: i32 = -2.9 as i32;   // -2
```

#### 浮動小数点型間のキャスト

- `f32` → `f64`: 精度が保持される
- `f64` → `f32`: 最も近い `f32` 値に丸められる

#### bool ↔ 数値型のキャスト

- `bool` → 整数型: `true` は `1`、`false` は `0`
- 整数型 → `bool`: `0` は `false`、それ以外は `true`
- `bool` → 浮動小数点型: `true` は `1.0`、`false` は `0.0`
- 浮動小数点型 → `bool`: `0.0` は `false`、それ以外は `true`

```cz
let e: i32 = true as i32;   // 1
let f: bool = 0 as bool;    // false
let g: bool = 42 as bool;   // true
let h: f64 = true as f64;   // 1.0
```

### 禁止されるキャスト

- ユニット型 `()` と他の型間のキャスト
- タプル型のキャスト
- 構造体型・列挙型のキャスト

## 型の一致

- すべての変数宣言、関数の戻り値、演算において型の一致が要求される
- 異なる型同士の算術演算はコンパイルエラー (例: `i32` + `i64` はエラー、`as` でキャスト必要)
- `if` 式の then/else 分岐は同じ型を返さなければならない
- `match` 式の全アームは同じ型を返さなければならない

## 例

```cz
// プリミティブ型
let a: i8 = 127i8;
let b: i64 = 1000000i64;
let c: f64 = 3.14;
let d: f32 = 2.71f32;
let flag: bool = true;
let unit: () = ();

// 型キャスト
let x: i32 = 42;
let y: i64 = x as i64;
let z: f64 = x as f64;
let w: bool = x as bool;  // true

// 型推論 (型注釈省略)
let inferred = 42;         // i32
let pi = 3.14;             // f64
```

## 制約・制限

- 暗黙の型変換は一切行わない (すべてのキャストは `as` で明示)
- 整数オーバーフローの動作は未定義 (将来のマイルストーンで定義予定)
- 符号なし整数型 (`u8`, `u16`, `u32`, `u64`) はサポートしない
- 文字型 (`char`) はサポートしない
